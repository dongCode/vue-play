<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div>
      <div id="dom1"></div>
      <div id="dom2"></div>
    </div>
    <script>
      /* 
         1. 进阶可以收集匿名函数
      */
      const effects = new WeakMap()

      let active

      // 注册响应函数
      function effect(fn) {
        active = fn
        fn()
        active = null
      }

      const data = {
        msg1: 'hi1',
        msg2: 'hi2'
      }

      // reactive
      const reactive = new Proxy(data, {
        get(target, key) {
          if (!active) {
            return target[key]
          } else {
            // effects ->WeakMap target -> Map key ->Set  effects
            let mapKeys = effects.get(target)

            // 对应的target不存在
            if (!mapKeys) {
              mapKeys = new Map()

              effects.set(target, mapKeys)
            }

            // 对应的key Set不存在
            if (!mapKeys.get(key)) {
              mapKeys.set(key, new Set())
            }

            mapKeys.get(key).add(active)

            console.log('mapKeys', mapKeys.get(key), key)

            return target[key]
          }
        },
        set(target, key, value) {
          target[key] = value
          let mapKeys = effects.get(target)
          if (mapKeys && mapKeys.get(key)) {
            mapKeys.get(key).forEach((fn) => fn())
          }
          return true
        }
      })

      // 收集操作
      effect(() => {
        document.querySelector('#dom1').innerHTML = reactive.msg1
      })
      effect(() => {
        document.querySelector('#dom2').innerHTML = reactive.msg2
      })

      // 添加新的操作，但是没有相关的effect也会执行
      setTimeout(() => {
        reactive.msg1 = 1
        reactive.msg2 = 2
      }, 1000)
    </script>
  </body>
</html>
